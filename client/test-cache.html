<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cache Test - RS Charts</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #2a2a2a;
        }
        .success { background: #1a4d2e; }
        .error { background: #4d1a1a; }
        .info { background: #1a2d4d; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #4a5568;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #5a6578;
        }
        pre {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>RS Charts Cache Test</h1>
    
    <div id="status"></div>
    
    <div>
        <h2>Service Worker</h2>
        <button onclick="checkServiceWorker()">Check Service Worker</button>
        <button onclick="sendTestMessage()">Send Test Message</button>
        <button onclick="getCacheStats()">Get Cache Stats</button>
    </div>
    
    <div>
        <h2>IndexedDB Cache</h2>
        <button onclick="checkIndexedDB()">Check IndexedDB</button>
        <button onclick="testCacheOperations()">Test Cache Operations</button>
        <button onclick="clearCache()">Clear Cache</button>
    </div>
    
    <div>
        <h2>Fetch Test</h2>
        <button onclick="testFetchWithCache()">Test Fetch with Cache</button>
        <button onclick="testPrefetch()">Test Prefetch</button>
    </div>
    
    <div>
        <h2>Results</h2>
        <pre id="results"></pre>
    </div>

    <script type="module">
        window.addStatus = function(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            statusDiv.insertBefore(div, statusDiv.firstChild);
        }
        
        window.updateResults = function(data) {
            document.getElementById('results').textContent = JSON.stringify(data, null, 2);
        }
        
        window.checkServiceWorker = async function() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        addStatus(`Service Worker registered: ${registration.scope}`, 'success');
                        updateResults({
                            scope: registration.scope,
                            active: registration.active ? 'Yes' : 'No',
                            installing: registration.installing ? 'Yes' : 'No',
                            waiting: registration.waiting ? 'Yes' : 'No',
                        });
                    } else {
                        addStatus('Service Worker not registered', 'error');
                    }
                } catch (error) {
                    addStatus(`Error checking Service Worker: ${error.message}`, 'error');
                }
            } else {
                addStatus('Service Workers not supported', 'error');
            }
        }
        
        window.sendTestMessage = function() {
            if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'CACHE_STATS'
                });
                addStatus('Test message sent to Service Worker', 'info');
            } else {
                addStatus('No active Service Worker controller', 'error');
            }
        }
        
        window.getCacheStats = async function() {
            if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                const channel = new MessageChannel();
                
                channel.port1.onmessage = (event) => {
                    if (event.data.type === 'CACHE_STATS_RESPONSE') {
                        addStatus('Cache stats received', 'success');
                        updateResults(event.data.stats);
                    }
                };
                
                navigator.serviceWorker.controller.postMessage({
                    type: 'CACHE_STATS'
                }, [channel.port2]);
                
                addStatus('Requesting cache stats...', 'info');
            } else {
                addStatus('No active Service Worker controller', 'error');
            }
        }
        
        window.checkIndexedDB = async function() {
            try {
                const databases = await indexedDB.databases();
                const rsChartsDb = databases.find(db => db.name === 'RSChartsCache');
                
                if (rsChartsDb) {
                    addStatus(`IndexedDB found: ${rsChartsDb.name} v${rsChartsDb.version}`, 'success');
                    
                    // Open database to check stores
                    const db = await new Promise((resolve, reject) => {
                        const request = indexedDB.open('RSChartsCache');
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                    
                    const objectStores = Array.from(db.objectStoreNames);
                    updateResults({
                        name: db.name,
                        version: db.version,
                        stores: objectStores
                    });
                    
                    db.close();
                } else {
                    addStatus('IndexedDB not found - will be created on first use', 'info');
                }
            } catch (error) {
                addStatus(`Error checking IndexedDB: ${error.message}`, 'error');
            }
        }
        
        window.testCacheOperations = async function() {
            try {
                // Import the cache module
                const { IndexedDBCache } = await import('./indexeddb-cache.js');
                const cache = new IndexedDBCache();
                
                // Test data
                const testCandle = {
                    timestamp: Date.now(),
                    open: 100,
                    high: 105,
                    low: 95,
                    close: 102,
                    volume: 1000,
                    live: false,
                    granularity: 'ONE_HOUR',
                    evaluations: []
                };
                
                const candles = new Map([[testCandle.timestamp, testCandle]]);
                
                // Test update
                await cache.updateCache(
                    'TEST-USD',
                    'ONE_HOUR',
                    { start: testCandle.timestamp - 3600000, end: testCandle.timestamp + 3600000 },
                    candles,
                    []
                );
                
                addStatus('Test candle stored in cache', 'success');
                
                // Test retrieval
                const retrieved = await cache.getCachedCandles(
                    'TEST-USD',
                    'ONE_HOUR',
                    { start: testCandle.timestamp - 3600000, end: testCandle.timestamp + 3600000 },
                    []
                );
                
                if (retrieved.size > 0) {
                    addStatus(`Retrieved ${retrieved.size} candles from cache`, 'success');
                    updateResults({
                        stored: 1,
                        retrieved: retrieved.size,
                        candle: retrieved.get(testCandle.timestamp)
                    });
                } else {
                    addStatus('No candles retrieved from cache', 'error');
                }
                
                // Get cache stats
                const stats = await cache.getCacheStats();
                addStatus(`Cache stats: ${stats.totalRecords} records, ${stats.totalSize} bytes`, 'info');
                
            } catch (error) {
                addStatus(`Error testing cache operations: ${error.message}`, 'error');
            }
        }
        
        window.clearCache = async function() {
            try {
                // Clear IndexedDB
                const { IndexedDBCache } = await import('./indexeddb-cache.js');
                const cache = new IndexedDBCache();
                await cache.clearCache();
                addStatus('IndexedDB cache cleared', 'success');
                
                // Clear Service Worker cache
                if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'CLEAR_CACHE'
                    });
                    addStatus('Service Worker cache clear requested', 'info');
                }
            } catch (error) {
                addStatus(`Error clearing cache: ${error.message}`, 'error');
            }
        }
        
        window.testFetchWithCache = async function() {
            try {
                const { CandleRepository } = await import('./candle-repository.js');
                const repo = new CandleRepository('https://market.spotcanvas.com');
                
                const now = Date.now();
                const timeRange = {
                    start: now - 24 * 60 * 60 * 1000, // 24 hours ago
                    end: now
                };
                
                addStatus('Fetching BTC-USD candles...', 'info');
                
                const startTime = performance.now();
                const candles = await repo.fetchCandles({
                    symbol: 'BTC-USD',
                    granularity: 'ONE_HOUR',
                    timeRange,
                    indicators: [],
                    source: 'test'
                });
                const fetchTime = performance.now() - startTime;
                
                addStatus(`Fetched ${candles.size} candles in ${fetchTime.toFixed(2)}ms`, 'success');
                
                // Fetch again to test cache
                addStatus('Fetching again to test cache...', 'info');
                const startTime2 = performance.now();
                const candles2 = await repo.fetchCandles({
                    symbol: 'BTC-USD',
                    granularity: 'ONE_HOUR',
                    timeRange,
                    indicators: [],
                    source: 'test-cache'
                });
                const cacheTime = performance.now() - startTime2;
                
                addStatus(`Fetched from cache: ${candles2.size} candles in ${cacheTime.toFixed(2)}ms`, 'success');
                
                updateResults({
                    firstFetch: {
                        candles: candles.size,
                        time: `${fetchTime.toFixed(2)}ms`
                    },
                    cachedFetch: {
                        candles: candles2.size,
                        time: `${cacheTime.toFixed(2)}ms`
                    },
                    speedup: `${(fetchTime / cacheTime).toFixed(2)}x`
                });
                
            } catch (error) {
                addStatus(`Error testing fetch: ${error.message}`, 'error');
            }
        }
        
        window.testPrefetch = function() {
            if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                const now = Date.now();
                navigator.serviceWorker.controller.postMessage({
                    type: 'PREFETCH_REQUEST',
                    data: {
                        symbol: 'ETH-USD',
                        granularity: 'ONE_HOUR',
                        timeRange: {
                            start: now - 48 * 60 * 60 * 1000,
                            end: now - 24 * 60 * 60 * 1000
                        },
                        indicators: [],
                        priority: 10
                    }
                });
                addStatus('Prefetch request sent for ETH-USD', 'info');
            } else {
                addStatus('No active Service Worker controller', 'error');
            }
        }
        
        // Listen for Service Worker messages
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                const { type } = event.data;
                if (type === 'PREFETCH_COMPLETE') {
                    addStatus('Prefetch completed', 'success');
                } else if (type === 'PREFETCH_FAILED') {
                    addStatus(`Prefetch failed: ${event.data.error}`, 'error');
                } else if (type === 'CACHE_CLEARED') {
                    addStatus('Service Worker cache cleared', 'success');
                }
            });
        }
        
        // Initial check
        setTimeout(() => {
            checkServiceWorker();
            checkIndexedDB();
        }, 1000);
    </script>
</body>
</html>