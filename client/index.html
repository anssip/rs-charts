<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title>SpotCanvas - Chart API Demo</title>

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap"
            rel="stylesheet"
        />

        <link rel="stylesheet" href="styles.css" />
        <script type="module" src="index.js"></script>

        <style>
            .upgrade-popup {
                display: none;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--color-primary-dark);
                padding: 24px;
                border-radius: 12px;
                border: 1px solid rgba(143, 143, 143, 0.2);
                text-align: center;
                z-index: 10000;
                backdrop-filter: blur(8px);
                box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
            }

            .upgrade-popup.show {
                display: block;
            }

            .upgrade-popup-text {
                color: var(--color-accent-2);
                font-size: 16px;
                margin-bottom: 20px;
            }

            .upgrade-button {
                background: var(--color-primary);
                color: var(--color-accent-2);
                border: none;
                padding: 8px 24px;
                border-radius: 6px;
                font-size: 14px;
                cursor: pointer;
                transition:
                    transform 0.2s ease,
                    background-color 0.2s ease;
                font-family: var(--font-primary);
            }

            .upgrade-button:hover {
                transform: scale(1.05);
                background: var(--color-primary);
                opacity: 0.9;
            }

            .upgrade-backdrop {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(2px);
                z-index: 9999;
            }

            .upgrade-backdrop.show {
                display: block !important;
            }

            .upgrade-popup.show {
                display: block !important;
            }

            /* Demo Controls Styles */
            .demo-controls {
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--color-primary-dark);
                padding: 20px;
                border-radius: 12px;
                border: 1px solid rgba(143, 143, 143, 0.2);
                z-index: 1000;
                backdrop-filter: blur(8px);
                box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
                max-width: 660px;
                max-height: 80vh;
                overflow-y: auto;
            }

            .controls-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            .controls-header {
                grid-column: 1 / -1;
            }

            .demo-controls h3 {
                color: var(--color-accent-2);
                margin: 0 0 15px 0;
                font-size: 16px;
                font-weight: 600;
            }

            .control-group {
                margin-bottom: 15px;
            }

            .control-group label {
                display: block;
                color: var(--color-accent-2);
                font-size: 14px;
                font-weight: 500;
                margin-bottom: 8px;
            }

            .control-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
            }

            .control-button {
                padding: 6px 12px;
                border: 1px solid rgba(143, 143, 143, 0.3);
                background: rgba(255, 255, 255, 0.1);
                color: var(--color-accent-2);
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                font-family: var(--font-primary);
                transition: all 0.2s;
            }

            .control-button:hover {
                background: rgba(255, 255, 255, 0.2);
                border-color: rgba(143, 143, 143, 0.5);
            }

            .control-button.active {
                background: var(--color-primary);
                border-color: var(--color-primary);
                color: white;
            }

            .control-button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .demo-status {
                margin-top: 15px;
                padding: 10px;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 6px;
                font-size: 12px;
                color: var(--color-accent-2);
                font-family: "Courier New", monospace;
            }

            .chart-selector {
                margin-bottom: 15px;
            }

            .chart-selector select {
                width: 100%;
                padding: 8px;
                border: 1px solid rgba(143, 143, 143, 0.3);
                background: rgba(255, 255, 255, 0.1);
                color: var(--color-accent-2);
                border-radius: 6px;
                font-family: var(--font-primary);
                font-size: 14px;
            }

            .toggle-controls {
                position: fixed;
                top: 20px;
                right: 340px;
                background: var(--color-primary);
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 8px;
                cursor: pointer;
                font-family: var(--font-primary);
                font-size: 14px;
                z-index: 1001;
            }

            .demo-controls.hidden {
                display: none;
            }

            /* App Header Styles */
            .app-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 60px;
                background: var(--color-primary-dark);
                border-bottom: 1px solid var(--color-background-secondary-20);
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0 20px;
                z-index: 100;
            }

            .header-left {
                display: flex;
                align-items: center;
                gap: 20px;
            }

            .header-right {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            /* Charts wrapper positioning handled in styles.css */

            product-select {
                width: 200px;
            }

            .toggle-controls {
                position: static;
            }

            .demo-controls {
                top: 80px; /* Move down to avoid header */
            }
        </style>
    </head>

    <body>
        <div class="app-header">
            <div class="header-left">
                <product-select id="symbol-selector"></product-select>
            </div>
            <div class="header-right">
                <button class="toggle-controls" onclick="toggleDemoControls()">
                    Toggle API Demo
                </button>
            </div>
        </div>

        <div class="demo-controls" id="demo-controls">
            <div class="controls-header">
                <h3>Chart API Demo</h3>

                <div class="chart-selector">
                    <label>Select Chart:</label>
                    <select id="chart-select" onchange="selectChart()">
                        <option value="1">Chart 1 (BTC-USD)</option>
                        <option value="2">Chart 2 (ETH-USD)</option>
                    </select>
                </div>
            </div>

            <div class="controls-grid">
                <div class="control-group">
                    <label>Symbol:</label>
                    <div class="control-buttons">
                        <button
                            class="control-button"
                            onclick="changeSymbol('BTC-USD')"
                        >
                            BTC-USD
                        </button>
                        <button
                            class="control-button"
                            onclick="changeSymbol('ETH-USD')"
                        >
                            ETH-USD
                        </button>
                        <button
                            class="control-button"
                            onclick="changeSymbol('SOL-USD')"
                        >
                            SOL-USD
                        </button>
                        <button
                            class="control-button"
                            onclick="changeSymbol('AVAX-USD')"
                        >
                            AVAX-USD
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Timeframe:</label>
                    <div class="control-buttons">
                        <button
                            class="control-button"
                            onclick="changeGranularity('ONE_MINUTE')"
                        >
                            1m
                        </button>
                        <button
                            class="control-button"
                            onclick="changeGranularity('FIVE_MINUTE')"
                        >
                            5m
                        </button>
                        <button
                            class="control-button"
                            onclick="changeGranularity('FIFTEEN_MINUTE')"
                        >
                            15m
                        </button>
                        <button
                            class="control-button"
                            onclick="changeGranularity('ONE_HOUR')"
                        >
                            1h
                        </button>
                        <button
                            class="control-button"
                            onclick="changeGranularity('SIX_HOUR')"
                        >
                            6h
                        </button>
                        <button
                            class="control-button"
                            onclick="changeGranularity('ONE_DAY')"
                        >
                            1d
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Indicators:</label>
                    <div class="control-buttons">
                        <button
                            class="control-button"
                            onclick="toggleIndicator('volume', 'Volume')"
                        >
                            Volume
                        </button>
                        <button
                            class="control-button"
                            onclick="toggleIndicator('rsi', 'RSI')"
                        >
                            RSI
                        </button>
                        <button
                            class="control-button"
                            onclick="toggleIndicator('macd', 'MACD')"
                        >
                            MACD
                        </button>
                        <button
                            class="control-button"
                            onclick="toggleIndicator('bollinger-bands', 'Bollinger Bands')"
                        >
                            BB
                        </button>
                        <button
                            class="control-button"
                            onclick="toggleIndicator('moving-averages', 'Moving Averages')"
                        >
                            MA
                        </button>
                        <button
                            class="control-button"
                            onclick="toggleIndicator('stochastic', 'Stochastic')"
                        >
                            Stoch
                        </button>
                        <button
                            class="control-button"
                            onclick="toggleIndicator('atr', 'ATR')"
                        >
                            ATR
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Display:</label>
                    <div class="control-buttons">
                        <button
                            class="control-button"
                            onclick="toggleFullWindow()"
                        >
                            Full Window
                        </button>
                        <button
                            class="control-button"
                            onclick="toggleFullscreen()"
                        >
                            Fullscreen
                        </button>
                        <button class="control-button" onclick="forceRedraw()">
                            Redraw
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Screenshot:</label>
                    <div class="control-buttons">
                        <button
                            class="control-button"
                            onclick="takeScreenshot()"
                            style="background: #4caf50; color: white"
                        >
                            üì∏ Download PNG
                        </button>
                        <button
                            class="control-button"
                            onclick="takeScreenshotJPEG()"
                            style="background: #2196f3; color: white"
                        >
                            üì∏ Download JPEG
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Time Range:</label>
                    <div class="control-buttons">
                        <button class="control-button" onclick="getTimeRange()">
                            Get Range
                        </button>
                        <button class="control-button" onclick="zoomInTime()">
                            Zoom In
                        </button>
                        <button class="control-button" onclick="zoomOutTime()">
                            Zoom Out
                        </button>
                        <button class="control-button" onclick="panLeft()">
                            ‚Üê Pan
                        </button>
                        <button class="control-button" onclick="panRight()">
                            Pan ‚Üí
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Price Range:</label>
                    <div class="control-buttons">
                        <button
                            class="control-button"
                            onclick="getPriceRange()"
                        >
                            Get Range
                        </button>
                        <button
                            class="control-button"
                            onclick="adjustPriceUp()"
                        >
                            ‚Üë Expand
                        </button>
                        <button
                            class="control-button"
                            onclick="adjustPriceDown()"
                        >
                            ‚Üì Contract
                        </button>
                        <button
                            class="control-button"
                            onclick="resetPriceRange()"
                        >
                            Auto Fit
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Trend Lines:</label>
                    <div class="control-buttons">
                        <button
                            class="control-button"
                            onclick="activateTrendLine()"
                        >
                            Draw Line
                        </button>
                        <button
                            class="control-button"
                            onclick="clearTrendLines()"
                        >
                            Clear All
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Pattern Highlights:</label>
                    <div class="control-buttons">
                        <button
                            class="control-button"
                            onclick="highlightBullishPatterns()"
                            style="color: #4ade80"
                        >
                            Bullish
                        </button>
                        <button
                            class="control-button"
                            onclick="highlightBearishPatterns()"
                            style="color: #ef4444"
                        >
                            Bearish
                        </button>
                        <button
                            class="control-button"
                            onclick="highlightNeutralPatterns()"
                            style="color: #fbbf24"
                        >
                            Neutral
                        </button>
                        <button
                            class="control-button"
                            onclick="highlightMixedPatterns()"
                        >
                            Mixed
                        </button>
                        <button
                            class="control-button"
                            onclick="createPulseWave()"
                            style="
                                background: linear-gradient(
                                    90deg,
                                    #10b981,
                                    #3b82f6,
                                    #a855f7
                                );
                                color: white;
                            "
                        >
                            Pulse Wave
                        </button>
                        <button
                            class="control-button"
                            onclick="clearPatternHighlights()"
                        >
                            Clear
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Trade Markers:</label>
                    <div class="control-buttons">
                        <button
                            class="control-button"
                            onclick="addBuyMarker()"
                            style="background: #10b981; color: white"
                        >
                            + Buy Marker
                        </button>
                        <button
                            class="control-button"
                            onclick="addSellMarker()"
                            style="background: #ef4444; color: white"
                        >
                            + Sell Marker
                        </button>
                        <button
                            class="control-button"
                            onclick="clearAllTradeMarkers()"
                        >
                            Clear Markers
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Price Lines:</label>
                    <div class="control-buttons">
                        <button
                            class="control-button"
                            onclick="addLimitOrderLine()"
                            style="background: #3b82f6; color: white"
                        >
                            + Limit Order
                        </button>
                        <button
                            class="control-button"
                            onclick="addStopLossLine()"
                            style="background: #ef4444; color: white"
                        >
                            + Stop Loss
                        </button>
                        <button
                            class="control-button"
                            onclick="addTakeProfitLine()"
                            style="background: #10b981; color: white"
                        >
                            + Take Profit
                        </button>
                        <button
                            class="control-button"
                            onclick="clearAllPriceLines()"
                        >
                            Clear Lines
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Position Overlay:</label>
                    <div class="control-buttons">
                        <button
                            class="control-button"
                            onclick="showLongPosition()"
                            style="background: #10b981; color: white"
                        >
                            Long Position
                        </button>
                        <button
                            class="control-button"
                            onclick="showShortPosition()"
                            style="background: #ef4444; color: white"
                        >
                            Short Position
                        </button>
                        <button
                            class="control-button"
                            onclick="togglePositionCompact()"
                        >
                            Toggle Compact
                        </button>
                        <button
                            class="control-button"
                            onclick="hidePositionOverlay()"
                        >
                            Hide Position
                        </button>
                        <button
                            class="control-button"
                            onclick="simulatePnLUpdate()"
                            style="background: #fbbf24; color: white"
                        >
                            Update P&L
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Trade Zones:</label>
                    <div class="control-buttons">
                        <button
                            class="control-button"
                            onclick="addProfitableTradeZone()"
                            style="background: #10b981; color: white"
                        >
                            + Profit Zone
                        </button>
                        <button
                            class="control-button"
                            onclick="addLosingTradeZone()"
                            style="background: #ef4444; color: white"
                        >
                            + Loss Zone
                        </button>
                        <button
                            class="control-button"
                            onclick="addLongTradeZone()"
                            style="background: #3b82f6; color: white"
                        >
                            + Long Trade
                        </button>
                        <button
                            class="control-button"
                            onclick="addShortTradeZone()"
                            style="background: #f59e0b; color: white"
                        >
                            + Short Trade
                        </button>
                        <button
                            class="control-button"
                            onclick="clearAllTradeZones()"
                        >
                            Clear Zones
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Annotations:</label>
                    <div class="control-buttons">
                        <button
                            class="control-button"
                            onclick="addNoteAnnotation()"
                            style="background: #8b5cf6; color: white"
                        >
                            üìù Add Note
                        </button>
                        <button
                            class="control-button"
                            onclick="addAlertAnnotation()"
                            style="background: #f59e0b; color: white"
                        >
                            üîî Add Alert
                        </button>
                        <button
                            class="control-button"
                            onclick="addMilestoneAnnotation()"
                            style="background: #10b981; color: white"
                        >
                            üèÅ Add Milestone
                        </button>
                        <button
                            class="control-button"
                            onclick="addDraggableAnnotation()"
                            style="background: #3b82f6; color: white"
                        >
                            ‚úã Draggable
                        </button>
                        <button
                            class="control-button"
                            onclick="clearAllAnnotations()"
                        >
                            Clear All
                        </button>
                    </div>
                </div>
            </div>
            <!-- End controls-grid -->

            <!-- Click-to-Trade Section -->
            <div
                class="control-group"
                style="
                    border-top: 1px solid rgba(143, 143, 143, 0.2);
                    padding-top: 10px;
                    margin-top: 10px;
                "
            >
                <label>Click-to-Trade:</label>
                <div class="control-buttons">
                    <button
                        id="enable-click-to-trade-btn"
                        class="control-button"
                        onclick="enableClickToTradeMode()"
                        style="background: #10b981; color: white"
                    >
                        Enable Click-to-Trade
                    </button>
                    <button
                        id="disable-click-to-trade-btn"
                        class="control-button"
                        onclick="disableClickToTradeMode()"
                        style="background: #ef4444; color: white"
                    >
                        Disable Click-to-Trade
                    </button>
                </div>
                <div
                    style="
                        font-size: 11px;
                        color: #888;
                        margin-top: 8px;
                        line-height: 1.4;
                    "
                >
                    Click chart to place order. Hold Shift to toggle buy/sell.
                </div>
            </div>

            <div id="trend-line-settings" style="display: none">
                <div class="control-group">
                    <label style="color: #4caf50">Selected Line:</label>
                    <div
                        style="
                            font-size: 11px;
                            color: #888;
                            margin-bottom: 10px;
                        "
                        id="selected-line-id"
                    >
                        -
                    </div>
                </div>

                <div class="control-group">
                    <label>Name:</label>
                    <input
                        type="text"
                        id="line-name"
                        placeholder="Line name"
                        style="width: 100%"
                    />
                </div>

                <div class="control-group">
                    <label>Description:</label>
                    <textarea
                        id="line-description"
                        placeholder="Line description"
                        style="width: 100%; min-height: 60px; resize: vertical"
                    ></textarea>
                </div>

                <div class="control-group">
                    <label>Color:</label>
                    <input
                        type="color"
                        id="line-color"
                        value="#2962ff"
                        style="width: 60px; height: 30px"
                    />
                </div>

                <div class="control-group">
                    <label>Width:</label>
                    <input
                        type="number"
                        id="line-width"
                        min="1"
                        max="10"
                        value="2"
                        style="width: 60px"
                    />
                </div>

                <div class="control-group">
                    <label>Style:</label>
                    <select id="line-style" style="width: 100%">
                        <option value="solid">Solid</option>
                        <option value="dashed">Dashed</option>
                        <option value="dotted">Dotted</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>
                        <input
                            type="checkbox"
                            id="extend-left"
                            style="margin-right: 5px"
                        />
                        Extend Left
                    </label>
                </div>

                <div class="control-group">
                    <label>
                        <input
                            type="checkbox"
                            id="extend-right"
                            style="margin-right: 5px"
                        />
                        Extend Right
                    </label>
                </div>

                <div class="control-group">
                    <label>Opacity: <span id="opacity-value">100%</span></label>
                    <input
                        type="range"
                        id="line-opacity"
                        min="0"
                        max="100"
                        value="100"
                        style="width: 100%"
                    />
                </div>

                <div class="control-group">
                    <label>Level Type:</label>
                    <select id="level-type" style="width: 100%">
                        <option value="">None</option>
                        <option value="swing">Swing</option>
                        <option value="horizontal">Horizontal</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Z-Index:</label>
                    <input
                        type="number"
                        id="z-index"
                        min="0"
                        max="1000"
                        value="0"
                        style="width: 100%"
                    />
                </div>

                <div
                    class="control-group"
                    style="
                        border-top: 1px solid rgba(143, 143, 143, 0.2);
                        padding-top: 10px;
                        margin-top: 10px;
                    "
                >
                    <label>
                        <input
                            type="checkbox"
                            id="pulse-animation-enabled"
                            style="margin-right: 5px"
                        />
                        Enable Pulse Animation
                    </label>
                </div>

                <div id="pulse-animation-settings" style="display: none">
                    <div class="control-group">
                        <label
                            >Duration:
                            <span id="pulse-duration-value">2000ms</span></label
                        >
                        <input
                            type="range"
                            id="pulse-duration"
                            min="500"
                            max="5000"
                            value="2000"
                            step="100"
                            style="width: 100%"
                        />
                    </div>

                    <div class="control-group">
                        <label
                            >Intensity:
                            <span id="pulse-intensity-value">30%</span></label
                        >
                        <input
                            type="range"
                            id="pulse-intensity"
                            min="10"
                            max="100"
                            value="30"
                            step="5"
                            style="width: 100%"
                        />
                    </div>
                </div>

                <div
                    class="control-group"
                    style="
                        border-top: 1px solid rgba(143, 143, 143, 0.2);
                        padding-top: 10px;
                        margin-top: 10px;
                    "
                >
                    <label>
                        <input
                            type="checkbox"
                            id="markers-enabled"
                            style="margin-right: 5px"
                        />
                        Enable Markers
                    </label>
                </div>

                <div id="marker-settings" style="display: none">
                    <div class="control-group">
                        <label>Marker Symbol:</label>
                        <select id="marker-symbol" style="width: 100%">
                            <option value="diamond">Diamond</option>
                            <option value="circle">Circle</option>
                            <option value="square">Square</option>
                            <option value="triangle">Triangle</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>Marker Size:</label>
                        <input
                            type="number"
                            id="marker-size"
                            min="1"
                            max="20"
                            value="4"
                            style="width: 100%"
                        />
                    </div>

                    <div class="control-group">
                        <label>Marker Spacing:</label>
                        <input
                            type="number"
                            id="marker-spacing"
                            min="10"
                            max="500"
                            value="100"
                            style="width: 100%"
                        />
                    </div>

                    <div class="control-group">
                        <label>Marker Color:</label>
                        <input
                            type="color"
                            id="marker-color"
                            value="#2962ff"
                            style="width: 60px; height: 30px"
                        />
                    </div>
                </div>

                <div
                    class="control-group"
                    style="
                        border-top: 1px solid rgba(143, 143, 143, 0.2);
                        padding-top: 10px;
                        margin-top: 10px;
                    "
                >
                    <label>Presets:</label>
                    <div class="control-buttons">
                        <button
                            class="control-button"
                            onclick="applySwingSupport()"
                            style="background: #4caf50"
                        >
                            Swing Support
                        </button>
                        <button
                            class="control-button"
                            onclick="applySwingResistance()"
                            style="background: #f44336"
                        >
                            Swing Resistance
                        </button>
                        <button
                            class="control-button"
                            onclick="applyHorizontalSupport()"
                            style="background: #66bb6a"
                        >
                            Horizontal Support
                        </button>
                        <button
                            class="control-button"
                            onclick="applyHorizontalResistance()"
                            style="background: #ef5350"
                        >
                            Horizontal Resistance
                        </button>
                    </div>
                </div>

                <div class="control-buttons">
                    <button
                        class="control-button"
                        onclick="deleteTrendLine()"
                        style="background: #ff5252"
                    >
                        Delete Line
                    </button>
                </div>
            </div>

            <div class="demo-status" id="demo-status">
                Select a chart to start...
            </div>
        </div>

        <div class="charts-wrapper">
            <div class="chart-container" id="chart-1"></div>
            <div class="chart-container" id="chart-2"></div>
        </div>

        <div class="upgrade-backdrop"></div>
        <div class="upgrade-popup">
            <div class="upgrade-popup-text">Upgrade to enable all features</div>
            <button class="upgrade-button">Upgrade</button>
        </div>

        <script>
            // Chart API Demo functionality
            let currentChart = 1;
            let chart1Api = null;
            let chart2Api = null;
            let selectedTrendLineId = null;
            let isUpdatingUI = false; // Prevent feedback loops

            // Preset functions for support/resistance
            function applySwingSupport() {
                const api = getCurrentApi();
                if (!api || !selectedTrendLineId) return;

                const settings = {
                    color: "#00FF00",
                    lineWidth: 3,
                    style: "solid",
                    opacity: 0.9,
                    levelType: "swing",
                    zIndex: 100,
                    markers: {
                        enabled: true,
                        symbol: "diamond",
                        size: 4,
                        spacing: 100,
                        color: "#00FF00",
                    },
                };

                api.updateTrendLineSettings(selectedTrendLineId, settings);
                updateTrendLineUI({ ...settings, id: selectedTrendLineId });
                updateStatus("Applied Swing Support preset");
            }

            function applySwingResistance() {
                const api = getCurrentApi();
                if (!api || !selectedTrendLineId) return;

                const settings = {
                    color: "#FF0000",
                    lineWidth: 3,
                    style: "solid",
                    opacity: 0.9,
                    levelType: "swing",
                    zIndex: 100,
                    markers: {
                        enabled: true,
                        symbol: "diamond",
                        size: 4,
                        spacing: 100,
                        color: "#FF0000",
                    },
                };

                api.updateTrendLineSettings(selectedTrendLineId, settings);
                updateTrendLineUI({ ...settings, id: selectedTrendLineId });
                updateStatus("Applied Swing Resistance preset");
            }

            function applyHorizontalSupport() {
                const api = getCurrentApi();
                if (!api || !selectedTrendLineId) return;

                const settings = {
                    color: "#66CC66",
                    lineWidth: 1.5,
                    style: "dashed",
                    opacity: 0.7,
                    levelType: "horizontal",
                    zIndex: 90,
                    markers: undefined,
                };

                api.updateTrendLineSettings(selectedTrendLineId, settings);
                updateTrendLineUI({ ...settings, id: selectedTrendLineId });
                updateStatus("Applied Horizontal Support preset");
            }

            function applyHorizontalResistance() {
                const api = getCurrentApi();
                if (!api || !selectedTrendLineId) return;

                const settings = {
                    color: "#FF6666",
                    lineWidth: 1.5,
                    style: "dashed",
                    opacity: 0.7,
                    levelType: "horizontal",
                    zIndex: 90,
                    markers: undefined,
                };

                api.updateTrendLineSettings(selectedTrendLineId, settings);
                updateTrendLineUI({ ...settings, id: selectedTrendLineId });
                updateStatus("Applied Horizontal Resistance preset");
            }

            function toggleDemoControls() {
                const controls = document.getElementById("demo-controls");
                controls.classList.toggle("hidden");
            }

            function selectChart() {
                const select = document.getElementById("chart-select");
                currentChart = parseInt(select.value);
                updateStatus();
                updateActiveButtons();
            }

            function getCurrentApi() {
                return currentChart === 1 ? chart1Api : chart2Api;
            }

            async function changeSymbol(symbol) {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    updateStatus("Changing symbol...");
                    await api.setSymbol(symbol);
                    updateStatus(`Symbol changed to ${symbol}`);
                    updateActiveButtons();
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            async function changeGranularity(granularity) {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    updateStatus("Changing timeframe...");
                    await api.setGranularity(granularity);
                    updateStatus(`Timeframe changed to ${granularity}`);
                    updateActiveButtons();
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function toggleIndicator(id, name) {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    api.toggleIndicator(id, { name });
                    updateStatus(`Toggled ${name} indicator`);
                    updateActiveButtons();
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            async function toggleFullscreen() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    await api.toggleFullscreen();
                    updateStatus("Toggled fullscreen");
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function toggleFullWindow() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    api.toggleFullWindow();
                    updateStatus("Toggled full window");
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function forceRedraw() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    api.redraw();
                    updateStatus("Chart redrawn");
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            // Screenshot functions
            async function takeScreenshot() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    updateStatus("Taking PNG screenshot...");
                    const symbol = api.getSymbol();
                    const granularity = api.getGranularity();
                    const filename = `${symbol}-${granularity}-${Date.now()}.png`;

                    await api.downloadScreenshot(filename, {
                        format: "png",
                        quality: 1.0,
                        scale: 2, // 2x resolution for better quality
                    });

                    updateStatus(`Screenshot saved as ${filename}`);
                } catch (error) {
                    updateStatus(`Screenshot error: ${error.message}`);
                }
            }

            async function takeScreenshotJPEG() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    updateStatus("Taking JPEG screenshot...");
                    const symbol = api.getSymbol();
                    const granularity = api.getGranularity();
                    const filename = `${symbol}-${granularity}-${Date.now()}.jpg`;

                    await api.downloadScreenshot(filename, {
                        format: "jpeg",
                        quality: 0.95,
                        backgroundColor: "#1a1a1a", // Dark background to match theme
                        scale: 2,
                    });

                    updateStatus(`Screenshot saved as ${filename}`);
                } catch (error) {
                    updateStatus(`Screenshot error: ${error.message}`);
                }
            }

            // Time Range functions
            function getTimeRange() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const range = api.getTimeRange();
                    const startDate = new Date(range.start).toLocaleString();
                    const endDate = new Date(range.end).toLocaleString();
                    updateStatus(
                        `Time Range:\nStart: ${startDate}\nEnd: ${endDate}`,
                    );
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function zoomInTime() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const currentRange = api.getTimeRange();
                    const duration = currentRange.end - currentRange.start;
                    const center = (currentRange.start + currentRange.end) / 2;
                    const newDuration = duration * 0.5;

                    api.setTimeRange({
                        start: center - newDuration / 2,
                        end: center + newDuration / 2,
                    });
                    updateStatus("Zoomed in time 50%");
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function zoomOutTime() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const currentRange = api.getTimeRange();
                    const duration = currentRange.end - currentRange.start;
                    const center = (currentRange.start + currentRange.end) / 2;
                    const newDuration = duration * 2;

                    api.setTimeRange({
                        start: center - newDuration / 2,
                        end: center + newDuration / 2,
                    });
                    updateStatus("Zoomed out time 200%");
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function panLeft() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const currentRange = api.getTimeRange();
                    const duration = currentRange.end - currentRange.start;
                    const shift = duration * 0.2;

                    api.setTimeRange({
                        start: currentRange.start - shift,
                        end: currentRange.end - shift,
                    });
                    updateStatus("Panned left");
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function panRight() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const currentRange = api.getTimeRange();
                    const duration = currentRange.end - currentRange.start;
                    const shift = duration * 0.2;

                    api.setTimeRange({
                        start: currentRange.start + shift,
                        end: currentRange.end + shift,
                    });
                    updateStatus("Panned right");
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            // Price Range functions
            function getPriceRange() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const range = api.getPriceRange();
                    updateStatus(
                        `Price Range:\nMin: $${range.min.toFixed(2)}\nMax: $${range.max.toFixed(2)}\nRange: $${range.range.toFixed(2)}`,
                    );
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function adjustPriceUp() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const currentRange = api.getPriceRange();
                    const adjustment = currentRange.range * 0.1;

                    api.setPriceRange({
                        min: currentRange.min - adjustment,
                        max: currentRange.max + adjustment,
                    });
                    updateStatus("Expanded price range by 10%");
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function adjustPriceDown() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const currentRange = api.getPriceRange();
                    const adjustment = currentRange.range * 0.1;

                    api.setPriceRange({
                        min: currentRange.min + adjustment,
                        max: currentRange.max - adjustment,
                    });
                    updateStatus("Contracted price range by 10%");
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function resetPriceRange() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    // Get visible candles to determine appropriate price range
                    const state = api.getState();
                    const timeRange = api.getTimeRange();
                    const visibleCandles = state.priceHistory.getCandlesInRange(
                        timeRange.start,
                        timeRange.end,
                    );

                    if (visibleCandles.length > 0) {
                        let minPrice = Infinity;
                        let maxPrice = -Infinity;

                        visibleCandles.forEach(([_, candle]) => {
                            minPrice = Math.min(minPrice, candle.low);
                            maxPrice = Math.max(maxPrice, candle.high);
                        });

                        // Add 5% padding
                        const padding = (maxPrice - minPrice) * 0.05;
                        api.setPriceRange({
                            min: minPrice - padding,
                            max: maxPrice + padding,
                        });
                        updateStatus("Auto-fitted price range to visible data");
                    } else {
                        updateStatus(
                            "No visible candles to determine price range",
                        );
                    }
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function activateTrendLine() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    api.activateTrendLineTool();
                    updateStatus(
                        "Trend line tool activated - click twice on chart",
                    );
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function clearTrendLines() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    api.clearTrendLines();
                    selectedTrendLineId = null;
                    document.getElementById(
                        "trend-line-settings",
                    ).style.display = "none";
                    updateStatus("All trend lines cleared");
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function deleteTrendLine() {
                const api = getCurrentApi();
                if (!api || !selectedTrendLineId) return;

                try {
                    api.removeTrendLine(selectedTrendLineId);
                    selectedTrendLineId = null;
                    document.getElementById(
                        "trend-line-settings",
                    ).style.display = "none";
                    updateStatus("Trend line deleted");
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            // Pattern Highlighting Functions
            function highlightBullishPatterns() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const candles = api.getCandles();
                    if (candles.length < 20) {
                        updateStatus(
                            "Not enough candles visible for pattern highlighting",
                        );
                        return;
                    }

                    const patterns = [
                        {
                            id: "bull_eng_1",
                            type: "pattern",
                            patternType: "bullish_engulfing",
                            name: "Bullish Engulfing",
                            description:
                                "Strong bullish reversal pattern. The second candle completely engulfs the first bearish candle, indicating potential trend reversal.",
                            candleTimestamps: [candles[4][0], candles[5][0]],
                            significance: "very high",
                            color: "#10b981",
                            style: "both", // Shows both outline and striped fill
                        },
                        {
                            id: "hammer_1",
                            type: "pattern",
                            patternType: "hammer",
                            name: "Hammer",
                            description:
                                "Bullish reversal pattern with long lower shadow and small body at resistance.",
                            candleTimestamps: [candles[10][0]],
                            significance: "high",
                            color: "#4ade80",
                            style: "fill", // Striped fill pattern
                        },
                        {
                            id: "morning_1",
                            type: "pattern",
                            patternType: "morning_star",
                            name: "Morning Star",
                            description:
                                "Three-candle bullish reversal pattern indicating strong buying pressure.",
                            candleTimestamps: [
                                candles[15][0],
                                candles[16][0],
                                candles[17][0],
                            ],
                            significance: "very high",
                            color: "#22c55e",
                            style: "fill",
                        },
                    ];

                    api.highlightPatterns(patterns);
                    updateStatus("Bullish patterns highlighted");
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function highlightBearishPatterns() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const candles = api.getCandles();
                    if (candles.length < 20) {
                        updateStatus(
                            "Not enough candles visible for pattern highlighting",
                        );
                        return;
                    }

                    const patterns = [
                        {
                            id: "bear_eng_1",
                            type: "pattern",
                            patternType: "bearish_engulfing",
                            name: "Bearish Engulfing",
                            description:
                                "Strong bearish reversal pattern. Selling pressure overwhelms buying pressure.",
                            candleTimestamps: [candles[7][0], candles[8][0]],
                            significance: "very high",
                            color: "#dc2626",
                            style: "both",
                        },
                        {
                            id: "shoot_1",
                            type: "pattern",
                            patternType: "shooting_star",
                            name: "Shooting Star",
                            description:
                                "Bearish reversal with long upper shadow at resistance level.",
                            candleTimestamps: [candles[12][0]],
                            significance: "high",
                            color: "#ef4444",
                            style: "outline",
                        },
                        {
                            id: "evening_1",
                            type: "pattern",
                            patternType: "evening_star",
                            name: "Evening Star",
                            description:
                                "Three-candle bearish reversal pattern at market top.",
                            candleTimestamps:
                                candles.length > 20
                                    ? [
                                          candles[18][0],
                                          candles[19][0],
                                          candles[20][0],
                                      ]
                                    : [
                                          candles[16][0],
                                          candles[17][0],
                                          candles[18][0],
                                      ],
                            significance: "very high",
                            color: "#b91c1c",
                            style: "fill",
                        },
                    ];

                    api.highlightPatterns(patterns);
                    updateStatus("Bearish patterns highlighted");
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function highlightNeutralPatterns() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const candles = api.getCandles();
                    if (candles.length < 15) {
                        updateStatus(
                            "Not enough candles visible for pattern highlighting",
                        );
                        return;
                    }

                    const patterns = [
                        {
                            id: "doji_1",
                            type: "pattern",
                            patternType: "doji",
                            name: "Doji",
                            description:
                                "Market indecision. Open and close are nearly equal, indicating equilibrium.",
                            candleTimestamps: [candles[3][0]],
                            significance: "medium",
                            color: "#fbbf24",
                            style: "outline",
                        },
                        {
                            id: "spin_1",
                            type: "pattern",
                            patternType: "spinning_top",
                            name: "Spinning Top",
                            description:
                                "Indecision pattern with small body and long shadows on both sides.",
                            candleTimestamps: [candles[8][0]],
                            significance: "low",
                            color: "#f59e0b",
                            style: "outline",
                        },
                        {
                            id: "inside_1",
                            type: "pattern",
                            patternType: "inside_bar",
                            name: "Inside Bar",
                            description:
                                "Consolidation pattern. Current bar is within previous bar range.",
                            candleTimestamps: [candles[11][0], candles[12][0]],
                            significance: "medium",
                            color: "#eab308",
                            style: "fill",
                        },
                    ];

                    api.highlightPatterns(patterns);
                    updateStatus("Neutral/Indecision patterns highlighted");
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function highlightMixedPatterns() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const candles = api.getCandles();
                    if (candles.length < 25) {
                        updateStatus(
                            "Not enough candles visible for pattern highlighting",
                        );
                        return;
                    }

                    const patterns = [
                        {
                            id: "mixed_1",
                            type: "pattern",
                            patternType: "bullish_engulfing",
                            name: "Bullish Engulfing",
                            description:
                                "Bullish reversal at support level. Strong buying pressure detected.",
                            candleTimestamps: [candles[5][0], candles[6][0]],
                            significance: "very high",
                            color: "#10b981",
                            style: "both",
                            nearLevel: {
                                type: "support",
                                price: candles[5][1].low,
                                distance: 0.5,
                            },
                        },
                        {
                            id: "mixed_2",
                            type: "pattern",
                            patternType: "doji",
                            name: "Doji",
                            description: "Market indecision after strong move.",
                            candleTimestamps: [candles[10][0]],
                            significance: "medium",
                            color: "#fbbf24",
                            style: "outline",
                        },
                        {
                            id: "mixed_3",
                            type: "pattern",
                            patternType: "shooting_star",
                            name: "Shooting Star",
                            description:
                                "Potential reversal at resistance. Watch for confirmation.",
                            candleTimestamps: [candles[15][0]],
                            significance: "high",
                            color: "#ef4444",
                            style: "both",
                            nearLevel: {
                                type: "resistance",
                                price: candles[15][1].high,
                                distance: 0.3,
                            },
                        },
                        {
                            id: "mixed_4",
                            type: "pattern",
                            patternType: "hammer",
                            name: "Hammer",
                            description:
                                "Bullish reversal signal with strong rejection of lower prices.",
                            candleTimestamps: [candles[20][0]],
                            significance: "high",
                            color: "#22c55e",
                            style: "outline",
                        },
                        {
                            id: "mixed_5",
                            type: "pattern",
                            patternType: "inside_bar",
                            name: "Inside Bar",
                            description:
                                "Consolidation before potential breakout.",
                            candleTimestamps: [candles[22][0], candles[23][0]],
                            significance: "low",
                            color: "#60a5fa",
                            style: "fill",
                        },
                    ];

                    api.highlightPatterns(patterns);
                    updateStatus(
                        `${patterns.length} mixed patterns highlighted`,
                    );
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function clearPatternHighlights() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    api.clearPatternHighlights();
                    updateStatus("All pattern highlights cleared");
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            // Trading Overlays - Trade Marker Functions
            function addBuyMarker() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const candles = api.getCandles();
                    if (candles.length === 0) {
                        updateStatus("No candles visible to add marker");
                        return;
                    }

                    // Pick a random candle from the visible range
                    const randomIndex = Math.floor(
                        Math.random() * candles.length,
                    );
                    const [timestamp, candle] = candles[randomIndex];

                    const markerId = api.addTradeMarker({
                        timestamp,
                        price: candle.close,
                        side: "buy",
                        shape: "arrow",
                        size: "medium",
                        text: "Entry",
                        tooltip: {
                            title: "Buy " + api.getSymbol(),
                            details: [
                                "Qty: 0.5",
                                `Price: $${candle.close.toFixed(2)}`,
                                `Total: $${(0.5 * candle.close).toFixed(2)}`,
                                `Time: ${new Date(timestamp).toLocaleString()}`,
                            ],
                        },
                        interactive: true,
                    });

                    const markers = api.getTradeMarkers();
                    updateStatus(
                        `Added buy marker. Total markers: ${markers.length}`,
                    );
                } catch (error) {
                    updateStatus(`Error adding buy marker: ${error.message}`);
                }
            }

            function addSellMarker() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const candles = api.getCandles();
                    if (candles.length === 0) {
                        updateStatus("No candles visible to add marker");
                        return;
                    }

                    // Pick a random candle from the visible range
                    const randomIndex = Math.floor(
                        Math.random() * candles.length,
                    );
                    const [timestamp, candle] = candles[randomIndex];

                    const markerId = api.addTradeMarker({
                        timestamp,
                        price: candle.close,
                        side: "sell",
                        shape: "flag",
                        size: "medium",
                        text: "Exit",
                        tooltip: {
                            title: "Sell " + api.getSymbol(),
                            details: [
                                "Qty: 0.5",
                                `Price: $${candle.close.toFixed(2)}`,
                                `Total: $${(0.5 * candle.close).toFixed(2)}`,
                                `P&L: +$${(Math.random() * 1000).toFixed(2)}`,
                                `Time: ${new Date(timestamp).toLocaleString()}`,
                            ],
                        },
                        interactive: true,
                    });

                    const markers = api.getTradeMarkers();
                    updateStatus(
                        `Added sell marker. Total markers: ${markers.length}`,
                    );
                } catch (error) {
                    updateStatus(`Error adding sell marker: ${error.message}`);
                }
            }

            function clearAllTradeMarkers() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    api.clearTradeMarkers();
                    updateStatus("All trade markers cleared");
                } catch (error) {
                    updateStatus(
                        `Error clearing trade markers: ${error.message}`,
                    );
                }
            }

            // Trading Overlays - Price Line Functions
            function addLimitOrderLine() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const priceRange = api.getPriceRange();
                    // Place limit order 2% above current min price
                    const price = priceRange.min + priceRange.range * 0.3;

                    const lineId = api.addPriceLine({
                        price,
                        color: "#3b82f6",
                        lineStyle: "dashed",
                        lineWidth: 2,
                        label: {
                            text: `Limit Buy @ $${price.toFixed(2)}`,
                            position: "right",
                            backgroundColor: "#3b82f6",
                            textColor: "#ffffff",
                        },
                        draggable: true,
                        extendLeft: true,
                        extendRight: true,
                        interactive: true,
                        showPriceLabel: true,
                        metadata: {
                            orderType: "limit",
                            side: "buy",
                            quantity: 0.5,
                        },
                    });

                    const lines = api.getPriceLines();
                    updateStatus(
                        `Added limit order line. Total lines: ${lines.length}`,
                    );
                } catch (error) {
                    updateStatus(
                        `Error adding limit order line: ${error.message}`,
                    );
                }
            }

            function addStopLossLine() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const priceRange = api.getPriceRange();
                    // Place stop loss 5% below max price
                    const price = priceRange.max - priceRange.range * 0.3;

                    const lineId = api.addPriceLine({
                        price,
                        color: "#ef4444",
                        lineStyle: "solid",
                        lineWidth: 2,
                        label: {
                            text: `Stop Loss @ $${price.toFixed(2)}`,
                            position: "left",
                            backgroundColor: "#ef4444",
                            textColor: "#ffffff",
                        },
                        draggable: true,
                        extendLeft: true,
                        extendRight: true,
                        interactive: true,
                        showPriceLabel: true,
                        metadata: {
                            stopType: "stop-loss",
                            triggerPrice: price,
                        },
                    });

                    const lines = api.getPriceLines();
                    updateStatus(
                        `Added stop loss line. Total lines: ${lines.length}`,
                    );
                } catch (error) {
                    updateStatus(
                        `Error adding stop loss line: ${error.message}`,
                    );
                }
            }

            function addTakeProfitLine() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const priceRange = api.getPriceRange();
                    // Place take profit 3% above max price
                    const price = priceRange.max + priceRange.range * 0.1;

                    const lineId = api.addPriceLine({
                        price,
                        color: "#10b981",
                        lineStyle: "dashed",
                        lineWidth: 2,
                        label: {
                            text: `Take Profit @ $${price.toFixed(2)}`,
                            position: "right",
                            backgroundColor: "#10b981",
                            textColor: "#ffffff",
                        },
                        draggable: true,
                        extendLeft: true,
                        extendRight: true,
                        interactive: true,
                        showPriceLabel: true,
                        metadata: {
                            orderType: "take-profit",
                            targetPrice: price,
                        },
                    });

                    const lines = api.getPriceLines();
                    updateStatus(
                        `Added take profit line. Total lines: ${lines.length}`,
                    );
                } catch (error) {
                    updateStatus(
                        `Error adding take profit line: ${error.message}`,
                    );
                }
            }

            function clearAllPriceLines() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    api.clearPriceLines();
                    updateStatus("All price lines cleared");
                } catch (error) {
                    updateStatus(
                        `Error clearing price lines: ${error.message}`,
                    );
                }
            }

            // Trading Overlays - Position Overlay Functions
            function showLongPosition() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const priceRange = api.getPriceRange();
                    const entryPrice = priceRange.min + priceRange.range * 0.4;
                    const currentPrice =
                        priceRange.min + priceRange.range * 0.6;
                    const quantity = 0.5;
                    const unrealizedPnL =
                        (currentPrice - entryPrice) * quantity;
                    const unrealizedPnLPercent =
                        ((currentPrice - entryPrice) / entryPrice) * 100;

                    api.setPositionOverlay({
                        symbol: api.getSymbol(),
                        quantity,
                        side: "long",
                        entryPrice,
                        currentPrice,
                        unrealizedPnL,
                        unrealizedPnLPercent,
                        position: "top-right",
                        showEntryLine: true,
                        entryLineColor: "#6b7280",
                        backgroundColor: "rgba(0, 0, 0, 0.9)",
                        textColor: "#ffffff",
                        opacity: 0.9,
                        compact: false,
                    });

                    updateStatus(
                        `Long position overlay shown: ${quantity} @ $${entryPrice.toFixed(2)}, P&L: $${unrealizedPnL.toFixed(2)} (${unrealizedPnLPercent.toFixed(2)}%)`,
                    );
                } catch (error) {
                    updateStatus(
                        `Error showing long position: ${error.message}`,
                    );
                }
            }

            function showShortPosition() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const priceRange = api.getPriceRange();
                    const entryPrice = priceRange.min + priceRange.range * 0.7;
                    const currentPrice =
                        priceRange.min + priceRange.range * 0.5;
                    const quantity = 1.0;
                    const unrealizedPnL =
                        (entryPrice - currentPrice) * quantity;
                    const unrealizedPnLPercent =
                        ((entryPrice - currentPrice) / entryPrice) * 100;

                    api.setPositionOverlay({
                        symbol: api.getSymbol(),
                        quantity,
                        side: "short",
                        entryPrice,
                        currentPrice,
                        unrealizedPnL,
                        unrealizedPnLPercent,
                        position: "top-left",
                        showEntryLine: true,
                        entryLineColor: "#6b7280",
                        backgroundColor: "rgba(255, 255, 255, 0.9)",
                        textColor: "#000000",
                        opacity: 0.9,
                        compact: false,
                    });

                    updateStatus(
                        `Short position overlay shown: ${quantity} @ $${entryPrice.toFixed(2)}, P&L: $${unrealizedPnL.toFixed(2)} (${unrealizedPnLPercent.toFixed(2)}%)`,
                    );
                } catch (error) {
                    updateStatus(
                        `Error showing short position: ${error.message}`,
                    );
                }
            }

            function togglePositionCompact() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const currentPosition = api.getPositionOverlay();
                    if (!currentPosition) {
                        updateStatus("No position overlay to toggle");
                        return;
                    }

                    // Convert compact to boolean (handles Proxy values from xinjs state)
                    // Use loose equality to coerce Proxy values to their primitive boolean
                    const isCurrentlyCompact = currentPosition.compact == true;

                    api.updatePositionOverlay({
                        compact: !isCurrentlyCompact,
                    });

                    updateStatus(
                        `Position overlay toggled to ${!isCurrentlyCompact ? "compact" : "full"} view`,
                    );
                } catch (error) {
                    updateStatus(
                        `Error toggling position compact: ${error.message}`,
                    );
                }
            }

            function hidePositionOverlay() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    api.setPositionOverlay(null);
                    updateStatus("Position overlay hidden");
                } catch (error) {
                    updateStatus(
                        `Error hiding position overlay: ${error.message}`,
                    );
                }
            }

            function simulatePnLUpdate() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const currentPosition = api.getPositionOverlay();
                    if (!currentPosition) {
                        updateStatus("No position overlay to update");
                        return;
                    }

                    // Simulate price movement (+/- 2%)
                    const priceChange =
                        currentPosition.currentPrice *
                        (Math.random() * 0.04 - 0.02);
                    const newPrice = currentPosition.currentPrice + priceChange;

                    let newPnL, newPnLPercent;
                    if (currentPosition.side === "long") {
                        newPnL =
                            (newPrice - currentPosition.entryPrice) *
                            currentPosition.quantity;
                        newPnLPercent =
                            ((newPrice - currentPosition.entryPrice) /
                                currentPosition.entryPrice) *
                            100;
                    } else {
                        newPnL =
                            (currentPosition.entryPrice - newPrice) *
                            currentPosition.quantity;
                        newPnLPercent =
                            ((currentPosition.entryPrice - newPrice) /
                                currentPosition.entryPrice) *
                            100;
                    }

                    api.updatePositionOverlay({
                        currentPrice: newPrice,
                        unrealizedPnL: newPnL,
                        unrealizedPnLPercent: newPnLPercent,
                    });

                    updateStatus(
                        `P&L updated: $${newPnL.toFixed(2)} (${newPnLPercent.toFixed(2)}%) @ $${newPrice.toFixed(2)}`,
                    );
                } catch (error) {
                    updateStatus(`Error updating P&L: ${error.message}`);
                }
            }

            // Trading Overlays - Trade Zone Functions
            function addProfitableTradeZone() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const candles = api.getCandles();
                    if (candles.length < 10) {
                        updateStatus(
                            "Not enough candles visible to add trade zone",
                        );
                        return;
                    }

                    // Pick a random range for the trade
                    const startIndex = Math.floor(
                        Math.random() * (candles.length - 10),
                    );
                    const duration = 5 + Math.floor(Math.random() * 8); // 5-12 candles
                    const endIndex = Math.min(
                        startIndex + duration,
                        candles.length - 1,
                    );

                    const startTimestamp = candles[startIndex][0];
                    const endTimestamp = candles[endIndex][0];
                    const entryPrice = candles[startIndex][1].close;
                    const exitPrice = entryPrice * 1.03; // 3% profit

                    const quantity = 0.1 + Math.random() * 0.5;
                    const pnl = (exitPrice - entryPrice) * quantity;
                    const pnlPercent =
                        ((exitPrice - entryPrice) / entryPrice) * 100;

                    const zoneId = api.addTradeZone({
                        startTimestamp,
                        endTimestamp,
                        entryPrice,
                        exitPrice,
                        textColor: "#ffffff", // White text for better visibility over candles
                        metadata: {
                            side: "long",
                            quantity,
                            pnl,
                            pnlPercent,
                        },
                    });

                    const zones = api.getTradeZones();
                    updateStatus(
                        `Added profitable trade zone (+${pnlPercent.toFixed(2)}%). Total zones: ${zones.length}`,
                    );
                } catch (error) {
                    updateStatus(
                        `Error adding profitable trade zone: ${error.message}`,
                    );
                }
            }

            function addLosingTradeZone() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const candles = api.getCandles();
                    if (candles.length < 10) {
                        updateStatus(
                            "Not enough candles visible to add trade zone",
                        );
                        return;
                    }

                    // Pick a random range for the trade
                    const startIndex = Math.floor(
                        Math.random() * (candles.length - 10),
                    );
                    const duration = 3 + Math.floor(Math.random() * 5); // 3-7 candles (shorter losing trade)
                    const endIndex = Math.min(
                        startIndex + duration,
                        candles.length - 1,
                    );

                    const startTimestamp = candles[startIndex][0];
                    const endTimestamp = candles[endIndex][0];
                    const entryPrice = candles[startIndex][1].close;
                    const exitPrice = entryPrice * 0.98; // 2% loss

                    const quantity = 0.1 + Math.random() * 0.5;
                    const pnl = (exitPrice - entryPrice) * quantity;
                    const pnlPercent =
                        ((exitPrice - entryPrice) / entryPrice) * 100;

                    const zoneId = api.addTradeZone({
                        startTimestamp,
                        endTimestamp,
                        entryPrice,
                        exitPrice,
                        metadata: {
                            side: "long",
                            quantity,
                            pnl,
                            pnlPercent,
                        },
                    });

                    const zones = api.getTradeZones();
                    updateStatus(
                        `Added losing trade zone (${pnlPercent.toFixed(2)}%). Total zones: ${zones.length}`,
                    );
                } catch (error) {
                    updateStatus(
                        `Error adding losing trade zone: ${error.message}`,
                    );
                }
            }

            function addLongTradeZone() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const timeRange = api.getTimeRange();
                    const priceRange = api.getPriceRange();

                    // Create a trade zone in the middle of the visible range
                    const duration = (timeRange.end - timeRange.start) * 0.2; // 20% of visible time
                    const startTimestamp =
                        timeRange.start +
                        (timeRange.end - timeRange.start) * 0.3;
                    const endTimestamp = startTimestamp + duration;

                    const entryPrice = priceRange.min + priceRange.range * 0.4;
                    const exitPrice = priceRange.min + priceRange.range * 0.6; // Higher exit = profit

                    const quantity = 0.5;
                    const pnl = (exitPrice - entryPrice) * quantity;
                    const pnlPercent =
                        ((exitPrice - entryPrice) / entryPrice) * 100;

                    const zoneId = api.addTradeZone({
                        startTimestamp,
                        endTimestamp,
                        entryPrice,
                        exitPrice,
                        metadata: {
                            side: "long",
                            quantity,
                            pnl,
                            pnlPercent,
                        },
                    });

                    const zones = api.getTradeZones();
                    updateStatus(
                        `Added long trade zone. Total zones: ${zones.length}`,
                    );
                } catch (error) {
                    updateStatus(
                        `Error adding long trade zone: ${error.message}`,
                    );
                }
            }

            function addShortTradeZone() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const timeRange = api.getTimeRange();
                    const priceRange = api.getPriceRange();

                    // Create a trade zone in the middle of the visible range
                    const duration = (timeRange.end - timeRange.start) * 0.15; // 15% of visible time
                    const startTimestamp =
                        timeRange.start +
                        (timeRange.end - timeRange.start) * 0.5;
                    const endTimestamp = startTimestamp + duration;

                    const entryPrice = priceRange.min + priceRange.range * 0.7;
                    const exitPrice = priceRange.min + priceRange.range * 0.5; // Lower exit = profit for short

                    const quantity = 0.3;
                    const pnl = (entryPrice - exitPrice) * quantity; // Reversed for short
                    const pnlPercent =
                        ((entryPrice - exitPrice) / entryPrice) * 100;

                    const zoneId = api.addTradeZone({
                        startTimestamp,
                        endTimestamp,
                        entryPrice,
                        exitPrice,
                        metadata: {
                            side: "short",
                            quantity,
                            pnl,
                            pnlPercent,
                        },
                    });

                    const zones = api.getTradeZones();
                    updateStatus(
                        `Added short trade zone. Total zones: ${zones.length}`,
                    );
                } catch (error) {
                    updateStatus(
                        `Error adding short trade zone: ${error.message}`,
                    );
                }
            }

            function clearAllTradeZones() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    api.clearTradeZones();
                    updateStatus("All trade zones cleared");
                } catch (error) {
                    updateStatus(
                        `Error clearing trade zones: ${error.message}`,
                    );
                }
            }

            // Annotations Functions
            function addNoteAnnotation() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const candles = api.getCandles();
                    if (candles.length === 0) {
                        updateStatus("No candles visible to add annotation");
                        return;
                    }

                    // Pick a random candle from the visible range
                    const randomIndex = Math.floor(
                        Math.random() * candles.length,
                    );
                    const [timestamp, candle] = candles[randomIndex];
                    const price = candle.close;

                    const annotationId = api.addAnnotation({
                        timestamp,
                        price,
                        text: "Important Level",
                        type: "note",
                        position: "above",
                        icon: "üìù",
                        color: "#ffffff",
                        backgroundColor: "rgba(139, 92, 246, 0.5)",
                        showLine: true,
                        lineStyle: "dashed",
                    });

                    const annotations = api.getAnnotations();
                    updateStatus(
                        `Added note annotation. Total annotations: ${annotations.length}`,
                    );
                } catch (error) {
                    updateStatus(
                        `Error adding note annotation: ${error.message}`,
                    );
                }
            }

            function addAlertAnnotation() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const candles = api.getCandles();
                    if (candles.length === 0) {
                        updateStatus("No candles visible to add annotation");
                        return;
                    }

                    // Pick a random candle from the visible range
                    const randomIndex = Math.floor(
                        Math.random() * candles.length,
                    );
                    const [timestamp, candle] = candles[randomIndex];

                    const annotationId = api.addAnnotation({
                        timestamp,
                        price: candle.high,
                        text: "Price Alert",
                        type: "alert",
                        position: "right",
                        icon: "üîî",
                        color: "#ffffff",
                        backgroundColor: "#f59e0b",
                        borderColor: "#d97706",
                        showLine: true,
                        lineStyle: "solid",
                    });

                    const annotations = api.getAnnotations();
                    updateStatus(
                        `Added alert annotation. Total annotations: ${annotations.length}`,
                    );
                } catch (error) {
                    updateStatus(
                        `Error adding alert annotation: ${error.message}`,
                    );
                }
            }

            function addMilestoneAnnotation() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const candles = api.getCandles();
                    if (candles.length === 0) {
                        updateStatus("No candles visible to add annotation");
                        return;
                    }

                    // Pick a random candle from the visible range
                    const randomIndex = Math.floor(
                        Math.random() * candles.length,
                    );
                    const [timestamp, candle] = candles[randomIndex];

                    const annotationId = api.addAnnotation({
                        timestamp,
                        price: candle.low,
                        text: "Milestone",
                        type: "milestone",
                        position: "below",
                        icon: "üèÅ",
                        color: "#ffffff",
                        backgroundColor: "#10b981",
                        borderColor: "#059669",
                        showLine: true,
                        lineStyle: "dotted",
                    });

                    const annotations = api.getAnnotations();
                    updateStatus(
                        `Added milestone annotation. Total annotations: ${annotations.length}`,
                    );
                } catch (error) {
                    updateStatus(
                        `Error adding milestone annotation: ${error.message}`,
                    );
                }
            }

            function addDraggableAnnotation() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    const timeRange = api.getTimeRange();
                    const priceRange = api.getPriceRange();

                    // Place in middle of visible range
                    const timestamp =
                        timeRange.start +
                        (timeRange.end - timeRange.start) * 0.5;
                    const price = priceRange.min + priceRange.range * 0.5;

                    const annotationId = api.addAnnotation({
                        timestamp,
                        price,
                        text: "Drag Me!",
                        type: "custom",
                        position: "left",
                        icon: "‚úã",
                        color: "#ffffff",
                        backgroundColor: "#3b82f6",
                        borderColor: "#2563eb",
                        draggable: true,
                        showLine: true,
                        lineStyle: "solid",
                        fontSize: 14,
                    });

                    const annotations = api.getAnnotations();
                    updateStatus(
                        `Added draggable annotation. Total annotations: ${annotations.length}`,
                    );
                } catch (error) {
                    updateStatus(
                        `Error adding draggable annotation: ${error.message}`,
                    );
                }
            }

            function clearAllAnnotations() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    api.clearAnnotations();
                    updateStatus("All annotations cleared");
                } catch (error) {
                    updateStatus(
                        `Error clearing annotations: ${error.message}`,
                    );
                }
            }

            // Click-to-Trade Functions
            function enableClickToTradeMode() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    // Enable click-to-trade with default configuration
                    api.enableClickToTrade({
                        enabled: true,
                        defaultSide: "buy",
                        showCrosshair: true,
                        showPriceLabel: true,
                        showOrderPreview: true,
                        allowSideToggle: true,
                        clickBehavior: "single",
                    });

                    // Listen for order-request events
                    api.on("order-request", (data) => {
                        const modifiers = [];
                        if (data.modifiers.shift) modifiers.push("Shift");
                        if (data.modifiers.ctrl) modifiers.push("Ctrl");
                        if (data.modifiers.alt) modifiers.push("Alt");

                        const timestamp = new Date(data.timestamp);
                        const timeStr = timestamp.toLocaleTimeString();
                        const dateStr = timestamp.toLocaleDateString();

                        updateStatus(
                            `ORDER REQUEST:\n` +
                                `Side: ${data.side.toUpperCase()}\n` +
                                `Price: $${data.price.toFixed(2)}\n` +
                                `Time: ${dateStr} ${timeStr}\n` +
                                `Modifiers: ${modifiers.join(", ") || "None"}`,
                        );
                    });

                    updateStatus(
                        "Click-to-Trade ENABLED\nClick on chart to place orders\nHold Shift to toggle buy/sell",
                    );
                    updateActiveButtons();
                } catch (error) {
                    updateStatus(
                        `Error enabling click-to-trade: ${error.message}`,
                    );
                }
            }

            function disableClickToTradeMode() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    api.disableClickToTrade();
                    updateStatus("Click-to-Trade DISABLED");
                    updateActiveButtons();
                } catch (error) {
                    updateStatus(
                        `Error disabling click-to-trade: ${error.message}`,
                    );
                }
            }

            // Pulsating Wave Effect Function
            function createPulseWave() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    // Use the new pulseWave API method with 5x speed (25 positions per update)
                    api.pulseWave({
                        speed: 20,
                        color: "#ec4899", // Pink
                        numCandles: 30,
                    });
                    updateStatus(
                        "Pulsating wave effect started - press Clear to stop",
                    );
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            }

            function updateTrendLineUI(trendLine) {
                isUpdatingUI = true;

                document.getElementById("selected-line-id").textContent =
                    trendLine.id.substring(0, 20) + "...";
                document.getElementById("line-name").value =
                    trendLine.name || "";
                document.getElementById("line-description").value =
                    trendLine.description || "";
                document.getElementById("line-color").value =
                    trendLine.color || "#2962ff";
                document.getElementById("line-width").value =
                    trendLine.lineWidth || 2;
                document.getElementById("line-style").value =
                    trendLine.style || "solid";
                document.getElementById("extend-left").checked =
                    trendLine.extendLeft || false;
                document.getElementById("extend-right").checked =
                    trendLine.extendRight || false;

                // New properties
                const opacity = (trendLine.opacity ?? 1.0) * 100;
                document.getElementById("line-opacity").value = opacity;
                document.getElementById("opacity-value").textContent =
                    Math.round(opacity) + "%";
                document.getElementById("level-type").value =
                    trendLine.levelType || "";
                document.getElementById("z-index").value =
                    trendLine.zIndex || 0;

                // Markers
                const markersEnabled = trendLine.markers?.enabled || false;
                document.getElementById("markers-enabled").checked =
                    markersEnabled;
                document.getElementById("marker-settings").style.display =
                    markersEnabled ? "block" : "none";

                if (markersEnabled && trendLine.markers) {
                    document.getElementById("marker-symbol").value =
                        trendLine.markers.symbol || "diamond";
                    document.getElementById("marker-size").value =
                        trendLine.markers.size || 4;
                    document.getElementById("marker-spacing").value =
                        trendLine.markers.spacing || 100;
                    document.getElementById("marker-color").value =
                        trendLine.markers.color || trendLine.color || "#2962ff";
                }

                isUpdatingUI = false;
            }

            function setupTrendLineControls() {
                // Name change
                document
                    .getElementById("line-name")
                    .addEventListener("input", (e) => {
                        if (isUpdatingUI || !selectedTrendLineId) return;
                        const api = getCurrentApi();
                        if (api) {
                            api.updateTrendLineSettings(selectedTrendLineId, {
                                name: e.target.value,
                            });
                            updateStatus(`Line name updated`);
                        }
                    });

                // Description change
                document
                    .getElementById("line-description")
                    .addEventListener("input", (e) => {
                        if (isUpdatingUI || !selectedTrendLineId) return;
                        const api = getCurrentApi();
                        if (api) {
                            api.updateTrendLineSettings(selectedTrendLineId, {
                                description: e.target.value,
                            });
                            updateStatus(`Line description updated`);
                        }
                    });

                // Color change
                document
                    .getElementById("line-color")
                    .addEventListener("change", (e) => {
                        if (isUpdatingUI || !selectedTrendLineId) return;
                        const api = getCurrentApi();
                        if (api) {
                            api.updateTrendLineSettings(selectedTrendLineId, {
                                color: e.target.value,
                            });
                            updateStatus(`Line color changed`);
                        }
                    });

                // Width change
                document
                    .getElementById("line-width")
                    .addEventListener("change", (e) => {
                        if (isUpdatingUI || !selectedTrendLineId) return;
                        const api = getCurrentApi();
                        if (api) {
                            api.updateTrendLineSettings(selectedTrendLineId, {
                                lineWidth: parseInt(e.target.value),
                            });
                            updateStatus(`Line width changed`);
                        }
                    });

                // Style change
                document
                    .getElementById("line-style")
                    .addEventListener("change", (e) => {
                        if (isUpdatingUI || !selectedTrendLineId) return;
                        const api = getCurrentApi();
                        if (api) {
                            api.updateTrendLineSettings(selectedTrendLineId, {
                                style: e.target.value,
                            });
                            updateStatus(`Line style changed`);
                        }
                    });

                // Extend left change
                document
                    .getElementById("extend-left")
                    .addEventListener("change", (e) => {
                        if (isUpdatingUI || !selectedTrendLineId) return;
                        const api = getCurrentApi();
                        if (api) {
                            api.updateTrendLineSettings(selectedTrendLineId, {
                                extendLeft: e.target.checked,
                            });
                            updateStatus(`Extend left: ${e.target.checked}`);
                        }
                    });

                // Extend right change
                document
                    .getElementById("extend-right")
                    .addEventListener("change", (e) => {
                        if (isUpdatingUI || !selectedTrendLineId) return;
                        const api = getCurrentApi();
                        if (api) {
                            api.updateTrendLineSettings(selectedTrendLineId, {
                                extendRight: e.target.checked,
                            });
                            updateStatus(`Extend right: ${e.target.checked}`);
                        }
                    });

                // Opacity change
                document
                    .getElementById("line-opacity")
                    .addEventListener("input", (e) => {
                        if (isUpdatingUI || !selectedTrendLineId) return;
                        const opacity = parseInt(e.target.value) / 100;
                        document.getElementById("opacity-value").textContent =
                            e.target.value + "%";
                        const api = getCurrentApi();
                        if (api) {
                            api.updateTrendLineSettings(selectedTrendLineId, {
                                opacity,
                            });
                            updateStatus(`Opacity: ${e.target.value}%`);
                        }
                    });

                // Level type change
                document
                    .getElementById("level-type")
                    .addEventListener("change", (e) => {
                        if (isUpdatingUI || !selectedTrendLineId) return;
                        const api = getCurrentApi();
                        if (api) {
                            api.updateTrendLineSettings(selectedTrendLineId, {
                                levelType: e.target.value || undefined,
                            });
                            updateStatus(
                                `Level type: ${e.target.value || "none"}`,
                            );
                        }
                    });

                // Z-index change
                document
                    .getElementById("z-index")
                    .addEventListener("change", (e) => {
                        if (isUpdatingUI || !selectedTrendLineId) return;
                        const api = getCurrentApi();
                        if (api) {
                            api.updateTrendLineSettings(selectedTrendLineId, {
                                zIndex: parseInt(e.target.value),
                            });
                            updateStatus(`Z-index: ${e.target.value}`);
                        }
                    });

                // Pulse Animation controls
                document
                    .getElementById("pulse-animation-enabled")
                    .addEventListener("change", (e) => {
                        if (isUpdatingUI || !selectedTrendLineId) return;
                        const api = getCurrentApi();
                        if (api) {
                            const animationSettings = e.target.checked
                                ? {
                                      animation: {
                                          type: "pulse",
                                          enabled: true,
                                          duration: parseInt(
                                              document.getElementById(
                                                  "pulse-duration",
                                              ).value,
                                          ),
                                          intensity:
                                              parseInt(
                                                  document.getElementById(
                                                      "pulse-intensity",
                                                  ).value,
                                              ) / 100,
                                      },
                                  }
                                : {
                                      animation: undefined,
                                  };
                            api.updateTrendLineSettings(
                                selectedTrendLineId,
                                animationSettings,
                            );
                            document.getElementById(
                                "pulse-animation-settings",
                            ).style.display = e.target.checked
                                ? "block"
                                : "none";
                            updateStatus(
                                `Pulse animation: ${e.target.checked ? "enabled" : "disabled"}`,
                            );
                        }
                    });

                document
                    .getElementById("pulse-duration")
                    .addEventListener("input", (e) => {
                        if (isUpdatingUI || !selectedTrendLineId) return;
                        const api = getCurrentApi();
                        if (api) {
                            const duration = parseInt(e.target.value);
                            document.getElementById(
                                "pulse-duration-value",
                            ).textContent = duration + "ms";
                            api.updateTrendLineSettings(selectedTrendLineId, {
                                animation: {
                                    type: "pulse",
                                    enabled: true,
                                    duration: duration,
                                    intensity:
                                        parseInt(
                                            document.getElementById(
                                                "pulse-intensity",
                                            ).value,
                                        ) / 100,
                                },
                            });
                            updateStatus(`Pulse duration: ${duration}ms`);
                        }
                    });

                document
                    .getElementById("pulse-intensity")
                    .addEventListener("input", (e) => {
                        if (isUpdatingUI || !selectedTrendLineId) return;
                        const api = getCurrentApi();
                        if (api) {
                            const intensity = parseInt(e.target.value);
                            document.getElementById(
                                "pulse-intensity-value",
                            ).textContent = intensity + "%";
                            api.updateTrendLineSettings(selectedTrendLineId, {
                                animation: {
                                    type: "pulse",
                                    enabled: true,
                                    duration: parseInt(
                                        document.getElementById(
                                            "pulse-duration",
                                        ).value,
                                    ),
                                    intensity: intensity / 100,
                                },
                            });
                            updateStatus(`Pulse intensity: ${intensity}%`);
                        }
                    });

                // Markers enabled change
                document
                    .getElementById("markers-enabled")
                    .addEventListener("change", (e) => {
                        if (isUpdatingUI || !selectedTrendLineId) return;
                        const enabled = e.target.checked;
                        document.getElementById(
                            "marker-settings",
                        ).style.display = enabled ? "block" : "none";
                        const api = getCurrentApi();
                        if (api) {
                            if (enabled) {
                                const markers = {
                                    enabled: true,
                                    symbol: document.getElementById(
                                        "marker-symbol",
                                    ).value,
                                    size: parseInt(
                                        document.getElementById("marker-size")
                                            .value,
                                    ),
                                    spacing: parseInt(
                                        document.getElementById(
                                            "marker-spacing",
                                        ).value,
                                    ),
                                    color: document.getElementById(
                                        "marker-color",
                                    ).value,
                                };
                                api.updateTrendLineSettings(
                                    selectedTrendLineId,
                                    { markers },
                                );
                            } else {
                                api.updateTrendLineSettings(
                                    selectedTrendLineId,
                                    { markers: undefined },
                                );
                            }
                            updateStatus(
                                `Markers: ${enabled ? "enabled" : "disabled"}`,
                            );
                        }
                    });

                // Marker settings changes
                [
                    "marker-symbol",
                    "marker-size",
                    "marker-spacing",
                    "marker-color",
                ].forEach((id) => {
                    document
                        .getElementById(id)
                        .addEventListener("change", (e) => {
                            if (isUpdatingUI || !selectedTrendLineId) return;
                            const api = getCurrentApi();
                            if (
                                api &&
                                document.getElementById("markers-enabled")
                                    .checked
                            ) {
                                const markers = {
                                    enabled: true,
                                    symbol: document.getElementById(
                                        "marker-symbol",
                                    ).value,
                                    size: parseInt(
                                        document.getElementById("marker-size")
                                            .value,
                                    ),
                                    spacing: parseInt(
                                        document.getElementById(
                                            "marker-spacing",
                                        ).value,
                                    ),
                                    color: document.getElementById(
                                        "marker-color",
                                    ).value,
                                };
                                api.updateTrendLineSettings(
                                    selectedTrendLineId,
                                    { markers },
                                );
                                updateStatus(`Marker settings updated`);
                            }
                        });
                });
            }

            function updateStatus(message) {
                const api = getCurrentApi();
                const statusEl = document.getElementById("demo-status");

                if (!api) {
                    statusEl.textContent = "No chart API available";
                    return;
                }

                if (message) {
                    statusEl.textContent = message;
                    return;
                }

                try {
                    const state = api.getState();
                    const status = `Chart ${currentChart}:
Symbol: ${api.getSymbol()}
Timeframe: ${api.getGranularity()}
Loading: ${api.isLoading()}
Indicators: ${
                        api
                            .getVisibleIndicators()
                            .map((i) => i.id)
                            .join(", ") || "None"
                    }`;
                    statusEl.textContent = status;
                } catch (error) {
                    statusEl.textContent = `Error getting status: ${error.message}`;
                }
            }

            function updateActiveButtons() {
                const api = getCurrentApi();
                if (!api) return;

                try {
                    // Update symbol buttons
                    document
                        .querySelectorAll(".control-button")
                        .forEach((btn) => {
                            btn.classList.remove("active");
                        });

                    const currentSymbol = api.getSymbol();
                    const currentGranularity = api.getGranularity();

                    // Find and activate current symbol button
                    document
                        .querySelectorAll(".control-button")
                        .forEach((btn) => {
                            const text = btn.textContent.trim();
                            if (
                                text === currentSymbol ||
                                (text === "1m" &&
                                    currentGranularity === "ONE_MINUTE") ||
                                (text === "5m" &&
                                    currentGranularity === "FIVE_MINUTE") ||
                                (text === "15m" &&
                                    currentGranularity === "FIFTEEN_MINUTE") ||
                                (text === "1h" &&
                                    currentGranularity === "ONE_HOUR") ||
                                (text === "6h" &&
                                    currentGranularity === "SIX_HOUR") ||
                                (text === "1d" &&
                                    currentGranularity === "ONE_DAY")
                            ) {
                                btn.classList.add("active");
                            }
                        });

                    // Update indicator buttons
                    const indicators = api.getVisibleIndicators();
                    document
                        .querySelectorAll(".control-button")
                        .forEach((btn) => {
                            const onclick = btn.getAttribute("onclick");
                            if (
                                onclick &&
                                onclick.includes("toggleIndicator")
                            ) {
                                const match = onclick.match(
                                    /toggleIndicator\('([^']+)'/,
                                );
                                if (match) {
                                    const indicatorId = match[1];
                                    if (api.isIndicatorVisible(indicatorId)) {
                                        btn.classList.add("active");
                                    }
                                }
                            }
                        });

                    // Update click-to-trade buttons
                    const enableBtn = document.getElementById(
                        "enable-click-to-trade-btn",
                    );
                    const disableBtn = document.getElementById(
                        "disable-click-to-trade-btn",
                    );

                    if (enableBtn && disableBtn) {
                        const isEnabled = api.isClickToTradeEnabled();

                        if (isEnabled) {
                            enableBtn.classList.add("active");
                            disableBtn.classList.remove("active");
                        } else {
                            enableBtn.classList.remove("active");
                            disableBtn.classList.add("active");
                        }
                    }
                } catch (error) {
                    console.error("Error updating buttons:", error);
                }
            }

            // Function to set up chart API event listeners
            function setupChartEventListeners() {
                if (window.chartApi1) {
                    chart1Api = window.chartApi1;
                    console.log("Chart 1 API connected");

                    // Chart ready event handler - just update UI, don't auto-enable indicators
                    chart1Api.on("ready", (data) => {
                        console.log(`Chart 1 ready for ${data.symbol}`);
                        updateStatus(`Chart 1 ready`);
                        updateActiveButtons();
                    });

                    // Trend line events
                    chart1Api.on("trend-line-selected", (data) => {
                        if (currentChart === 1) {
                            selectedTrendLineId = data.trendLineId;
                            document.getElementById(
                                "trend-line-settings",
                            ).style.display = "block";
                            updateTrendLineUI(data.trendLine);
                            updateStatus(
                                `Trend line selected: ${data.trendLineId.substring(0, 20)}...`,
                            );
                        }
                    });

                    chart1Api.on("trend-line-deselected", (data) => {
                        if (currentChart === 1) {
                            selectedTrendLineId = null;
                            document.getElementById(
                                "trend-line-settings",
                            ).style.display = "none";
                            updateStatus("Trend line deselected");
                        }
                    });

                    chart1Api.on("trend-line-deleted", (data) => {
                        if (currentChart === 1) {
                            // If the deleted line was selected, clear selection
                            if (selectedTrendLineId === data.trendLineId) {
                                selectedTrendLineId = null;
                                document.getElementById(
                                    "trend-line-settings",
                                ).style.display = "none";
                            }
                            updateStatus(
                                `Trend line deleted: ${data.trendLineId.substring(0, 20)}...`,
                            );
                        }
                    });

                    // Trading Overlays - Trade Marker events
                    chart1Api.on("trade-marker-clicked", (event) => {
                        if (currentChart === 1) {
                            console.log("Trade marker clicked:", event);
                            updateStatus(
                                `Trade marker clicked: ${event.markerId.substring(0, 30)}... at $${event.marker.price.toFixed(2)}`,
                            );
                        }
                    });

                    chart1Api.on("trade-marker-hovered", (event) => {
                        if (currentChart === 1) {
                            console.log("Trade marker hovered:", event);
                        }
                    });

                    // Trading Overlays - Price Line events
                    chart1Api.on("price-line-dragged", (event) => {
                        if (currentChart === 1) {
                            console.log("Price line dragged:", event);
                            updateStatus(
                                `Price line dragged from $${event.oldPrice.toFixed(2)} to $${event.newPrice.toFixed(2)}`,
                            );
                        }
                    });

                    chart1Api.on("price-line-clicked", (event) => {
                        if (currentChart === 1) {
                            console.log("Price line clicked:", event);
                            updateStatus(
                                `Price line clicked: ${event.lineId.substring(0, 30)}... at $${event.line.price.toFixed(2)}`,
                            );
                        }
                    });

                    chart1Api.on("price-line-hovered", (event) => {
                        if (currentChart === 1) {
                            console.log("Price line hovered:", event);
                        }
                    });

                    // Trading Overlays - Trade Zone events
                    chart1Api.on("trade-zone-clicked", (event) => {
                        if (currentChart === 1) {
                            console.log("Trade zone clicked:", event);
                            updateStatus(
                                `Trade zone clicked: ${event.zoneId.substring(0, 30)}... Entry: $${event.zone.entryPrice.toFixed(2)}, Exit: $${event.zone.exitPrice.toFixed(2)}`,
                            );
                        }
                    });

                    chart1Api.on("trade-zone-hovered", (event) => {
                        if (currentChart === 1) {
                            console.log("Trade zone hovered:", event);
                            const pnlText =
                                event.zone.metadata?.pnl !== undefined
                                    ? `P&L: $${event.zone.metadata.pnl.toFixed(2)}`
                                    : "";
                            const pnlPercentText =
                                event.zone.metadata?.pnlPercent !== undefined
                                    ? `(${event.zone.metadata.pnlPercent >= 0 ? "+" : ""}${event.zone.metadata.pnlPercent.toFixed(2)}%)`
                                    : "";
                            updateStatus(
                                `Trade zone hovered: ${event.zoneId.substring(0, 20)}... ${pnlText} ${pnlPercentText}`.trim(),
                            );
                        }
                    });

                    // Trading Overlays - Chart interaction events
                    chart1Api.on("price-clicked", (event) => {
                        if (currentChart === 1) {
                            console.log("Price clicked:", event);
                            updateStatus(
                                `Clicked price: $${event.price.toFixed(2)} at ${new Date(event.timestamp).toLocaleTimeString()}`,
                            );
                        }
                    });

                    chart1Api.on("crosshair-moved", (event) => {
                        if (
                            currentChart === 1 &&
                            event.price &&
                            event.timestamp
                        ) {
                            // Only log occasionally to avoid spam
                            if (Math.random() < 0.05) {
                                console.log("Crosshair moved:", event);
                            }
                        }
                    });

                    // Annotation events
                    chart1Api.on("annotation-dragged", (data) => {
                        if (currentChart === 1) {
                            const newDate = new Date(data.newTimestamp);
                            updateStatus(
                                `Annotation dragged:\n` +
                                    `New price: $${data.newPrice?.toFixed(2) || "N/A"}\n` +
                                    `New time: ${newDate.toLocaleString()}`,
                            );
                        }
                    });
                }
                if (window.chartApi2) {
                    chart2Api = window.chartApi2;
                    console.log("Chart 2 API connected");

                    // Chart ready event handler - just update UI, don't auto-enable indicators
                    chart2Api.on("ready", (data) => {
                        console.log(`Chart 2 ready for ${data.symbol}`);
                        if (currentChart === 2) {
                            updateStatus(`Chart 2 ready`);
                            updateActiveButtons();
                        }
                    });

                    // Trend line events
                    chart2Api.on("trend-line-selected", (data) => {
                        if (currentChart === 2) {
                            selectedTrendLineId = data.trendLineId;
                            document.getElementById(
                                "trend-line-settings",
                            ).style.display = "block";
                            updateTrendLineUI(data.trendLine);
                            updateStatus(
                                `Trend line selected: ${data.trendLineId.substring(0, 20)}...`,
                            );
                        }
                    });

                    chart2Api.on("trend-line-deselected", (data) => {
                        if (currentChart === 2) {
                            selectedTrendLineId = null;
                            document.getElementById(
                                "trend-line-settings",
                            ).style.display = "none";
                            updateStatus("Trend line deselected");
                        }
                    });

                    chart2Api.on("trend-line-deleted", (data) => {
                        if (currentChart === 2) {
                            // If the deleted line was selected, clear selection
                            if (selectedTrendLineId === data.trendLineId) {
                                selectedTrendLineId = null;
                                document.getElementById(
                                    "trend-line-settings",
                                ).style.display = "none";
                            }
                            updateStatus(
                                `Trend line deleted: ${data.trendLineId.substring(0, 20)}...`,
                            );
                        }
                    });

                    // Trading Overlays - Trade Marker events
                    chart2Api.on("trade-marker-clicked", (event) => {
                        if (currentChart === 2) {
                            console.log("Trade marker clicked:", event);
                            updateStatus(
                                `Trade marker clicked: ${event.markerId.substring(0, 30)}... at $${event.marker.price.toFixed(2)}`,
                            );
                        }
                    });

                    chart2Api.on("trade-marker-hovered", (event) => {
                        if (currentChart === 2) {
                            console.log("Trade marker hovered:", event);
                        }
                    });

                    // Trading Overlays - Price Line events
                    chart2Api.on("price-line-dragged", (event) => {
                        if (currentChart === 2) {
                            console.log("Price line dragged:", event);
                            updateStatus(
                                `Price line dragged from $${event.oldPrice.toFixed(2)} to $${event.newPrice.toFixed(2)}`,
                            );
                        }
                    });

                    chart2Api.on("price-line-clicked", (event) => {
                        if (currentChart === 2) {
                            console.log("Price line clicked:", event);
                            updateStatus(
                                `Price line clicked: ${event.lineId.substring(0, 30)}... at $${event.line.price.toFixed(2)}`,
                            );
                        }
                    });

                    chart2Api.on("price-line-hovered", (event) => {
                        if (currentChart === 2) {
                            console.log("Price line hovered:", event);
                        }
                    });

                    // Trading Overlays - Trade Zone events
                    chart2Api.on("trade-zone-clicked", (event) => {
                        if (currentChart === 2) {
                            console.log("Trade zone clicked:", event);
                            updateStatus(
                                `Trade zone clicked: ${event.zoneId.substring(0, 30)}... Entry: $${event.zone.entryPrice.toFixed(2)}, Exit: $${event.zone.exitPrice.toFixed(2)}`,
                            );
                        }
                    });

                    chart2Api.on("trade-zone-hovered", (event) => {
                        if (currentChart === 2) {
                            console.log("Trade zone hovered:", event);
                            const pnlText =
                                event.zone.metadata?.pnl !== undefined
                                    ? `P&L: $${event.zone.metadata.pnl.toFixed(2)}`
                                    : "";
                            const pnlPercentText =
                                event.zone.metadata?.pnlPercent !== undefined
                                    ? `(${event.zone.metadata.pnlPercent >= 0 ? "+" : ""}${event.zone.metadata.pnlPercent.toFixed(2)}%)`
                                    : "";
                            updateStatus(
                                `Trade zone hovered: ${event.zoneId.substring(0, 20)}... ${pnlText} ${pnlPercentText}`.trim(),
                            );
                        }
                    });

                    // Trading Overlays - Chart interaction events
                    chart2Api.on("price-clicked", (event) => {
                        if (currentChart === 2) {
                            console.log("Price clicked:", event);
                            updateStatus(
                                `Clicked price: $${event.price.toFixed(2)} at ${new Date(event.timestamp).toLocaleTimeString()}`,
                            );
                        }
                    });

                    chart2Api.on("crosshair-moved", (event) => {
                        if (
                            currentChart === 2 &&
                            event.price &&
                            event.timestamp
                        ) {
                            // Only log occasionally to avoid spam
                            if (Math.random() < 0.05) {
                                console.log("Crosshair moved:", event);
                            }
                        }
                    });

                    // Annotation events
                    chart2Api.on("annotation-dragged", (data) => {
                        if (currentChart === 2) {
                            const newDate = new Date(data.newTimestamp);
                            updateStatus(
                                `Annotation dragged:\n` +
                                    `New price: $${data.newPrice?.toFixed(2) || "N/A"}\n` +
                                    `New time: ${newDate.toLocaleString()}`,
                            );
                        }
                    });
                }
            }

            // Try to set up listeners immediately, then retry periodically if needed
            function initializeDemo() {
                if (window.chartApi1 || window.chartApi2) {
                    setupChartEventListeners();
                    updateStatus();
                    updateActiveButtons();

                    // Set up other event listeners
                    if (chart1Api) {
                        chart1Api.on("symbolChange", () => {
                            if (currentChart === 1) {
                                updateStatus();
                                updateActiveButtons();
                            }
                        });
                        chart1Api.on("granularityChange", () => {
                            if (currentChart === 1) {
                                updateStatus();
                                updateActiveButtons();
                            }
                        });
                        chart1Api.on("indicatorChange", () => {
                            if (currentChart === 1) {
                                updateStatus();
                                updateActiveButtons();
                            }
                        });
                    }

                    if (chart2Api) {
                        chart2Api.on("symbolChange", () => {
                            if (currentChart === 2) {
                                updateStatus();
                                updateActiveButtons();
                            }
                        });
                        chart2Api.on("granularityChange", () => {
                            if (currentChart === 2) {
                                updateStatus();
                                updateActiveButtons();
                            }
                        });
                        chart2Api.on("indicatorChange", () => {
                            if (currentChart === 2) {
                                updateStatus();
                                updateActiveButtons();
                            }
                        });
                    }
                    return true; // Successfully initialized
                }
                return false; // APIs not ready yet
            }

            // Initialize demo when charts are ready
            window.addEventListener("load", () => {
                // Set up trend line controls
                setupTrendLineControls();

                // Try to initialize immediately
                if (!initializeDemo()) {
                    // If APIs aren't ready yet, poll every 100ms
                    const pollInterval = setInterval(() => {
                        if (initializeDemo()) {
                            clearInterval(pollInterval);
                        }
                    }, 100);
                }
            });
        </script>
    </body>
</html>
